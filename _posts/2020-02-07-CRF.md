---
layout:     post
title:      ç»Ÿè®¡å­¦ä¹ æ–¹æ³•---CRF
subtitle:   CRF
date:       2020-02-07
author:     weber
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - machine learning
---

conditional random fieldï¼ŒCRF

# 1. ä¸€å¥è¯æ¦‚æ‹¬CRF

CRFæ˜¯ç»™å®šä¸€ç»„è¾“å…¥åºåˆ—æ¡ä»¶ä¸‹å¦ä¸€ç»„è¾“å‡ºåºåˆ—çš„æ¡ä»¶åˆ†å¸ƒæ¨¡å‹ã€‚

## 1.1 çº¿æ€§é“¾æ¡ä»¶éšæœºåœº

éšæœºåœºï¼šè‹¥å¹²ä¸ªä½ç½®ç»„æˆçš„æ•´ä½“ï¼Œå½“ç»™æ¯ä¸ªä½ç½®æŒ‰æŸç§åˆ†å¸ƒèµ‹äºˆä¸€ä¸ªå€¼åï¼Œå…¶å…¨ä½“å°±å«éšæœºåœºã€‚

é©¬å°”å¯å¤«éšæœºåœºï¼šæ¯ä¸ªä½ç½®çš„èµ‹å€¼ä»…ä»…ä¸å…¶ç›¸é‚»çš„ä½ç½®çš„èµ‹å€¼æœ‰å…³ã€‚

æ¡ä»¶éšæœºåœºï¼šåœ¨ç»™å®šéšæœºå˜é‡Xçš„æ¡ä»¶ä¸‹ï¼Œéšæœºå˜é‡Yçš„é©¬å°”å¯å¤«éšæœºåœºï¼Œåœ¨è¯æ€§æ ‡æ³¨æ—¶ï¼ŒXä¸ºè¯ï¼ŒYä¸ºè¯æ€§ã€‚

**çº¿æ€§é“¾æ¡ä»¶éšæœºåœº**ï¼š

è®¾$ğ‘‹=(ğ‘‹_1,ğ‘‹_2,...ğ‘‹_ğ‘›),ğ‘Œ=(ğ‘Œ_1,ğ‘Œ_2,...ğ‘Œ_ğ‘›)$å‡ä¸ºçº¿æ€§é“¾è¡¨ç¤ºçš„éšæœºå˜é‡åºåˆ—ï¼Œåœ¨ç»™å®šéšæœºå˜é‡åºåˆ—$X$çš„æƒ…å†µä¸‹ï¼Œéšæœºå˜é‡$Y$çš„æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒ$P(Y|X)$æ„æˆæ¡ä»¶éšæœºåœºï¼Œå³æ»¡è¶³é©¬å°”ç§‘å¤«æ€§ï¼š
$$
ğ‘ƒ(ğ‘Œ_ğ‘–|ğ‘‹,ğ‘Œ_1,ğ‘Œ_2,...ğ‘Œ_ğ‘›)=ğ‘ƒ(ğ‘Œ_ğ‘–|ğ‘‹,ğ‘Œ_{ğ‘–âˆ’1},ğ‘Œ_{ğ‘–+1})
$$

![æ¡ä»¶éšæœºåœºå®šä¹‰](https://tva1.sinaimg.cn/large/00831rSTgy1gdivm02baxj30ku055gmz.jpg)

## 1.2 ä¸‰ç§è¡¨ç¤ºæ–¹å¼

### 1.2.1 å‚æ•°å½¢å¼

$$
P(y|x) = \frac{1}{Z(x)} \exp (\sum_{i,k}\lambda_kt_k(y_{i-1},y_i,x,i)+\sum_{i,l}\mu_l s_{l}(y_{i},x,i)
$$

å…¶ä¸­ï¼Œ$t_k(y_{i-1},y_i,x,i)$ä¸ºå®šä¹‰åœ¨è¾¹ä¸Šçš„è½¬ç§»ç‰¹å¾ï¼Œä¾èµ–äºå½“å‰æ—¶åˆ»å’Œå‰ä¸€æ—¶åˆ»çš„ä½ç½®ï¼ŒKä¸ºè¯¥ç»“ç‚¹çš„è½¬ç§»ç‰¹å¾å‡½æ•°çš„æ€»ä¸ªæ•°ï¼›$s_l(y_i,x,i)$ä¸ºå®šä¹‰åœ¨ç»“ç‚¹ä¸Šçš„çŠ¶æ€ç‰¹å¾ï¼Œä¾èµ–äºå½“å‰ä½ç½®ï¼ŒLä¸ºè¯¥ç»“ç‚¹çš„çŠ¶æ€ç‰¹å¾å‡½æ•°çš„æ€»ä¸ªæ•°ã€‚Z(x)ä¸ºæ‰€æœ‰åºåˆ—Yçš„å’Œï¼Œå³å½’ä¸€åŒ–å› å­ã€‚

### 1.2.2 ç®€åŒ–å½¢å¼

$$
P(y|x) = \frac{1}{Z(x)} \exp(\sum_{k=1}^K(w_kf_k(y,x)))
$$

å…¶ä¸­ï¼Œ
$$
w_k = \left\{
\begin{array}{}
\lambda_k,  k=1,2,...K_1\\
\mu_l, k=K_2+1,K_1+2,...K
\end{array}
\right.
$$

$$
f_k(y_,x) = \sum_{i=1}^n(f_k(y_{i-1},y_i,x,i))
$$

å…¶ä¸­ï¼Œ
$$
f_k(y_{i-1},y_i,x,i) = \left\{
\begin{array}{}
t_k(y_{i-1},y_i,x,i),  k=1,2,...K_1\\
s_k(y_{i},x,i), k=K_2+1,K_1+2,...K
\end{array}
\right.
$$

### 1.2.3 çŸ©é˜µå½¢å¼

$$
P(y|x) =\frac{1}{Z_w(x)} \prod_{i=1}^{n+1}[M_i(y_{i-1},y_i|x)]
$$

å…¶ä¸­ï¼Œ

$$
M_i(y_{i-1},y_i|x) = \exp (W_i(y_{i-1},y_i,x)) = \exp(\sum_{k=1}^K(w_kf_k(y_{i-1},y_i,x,i)))
$$

æœ‰çŸ©é˜µ 

$$
M_i(x) = [M_i(y_{i-1},y_i|x)]_{m \times m}
$$

# 2. ä¸‰ä¸ªé—®é¢˜

## 2.1 æ¦‚ç‡è®¡ç®—

å·²çŸ¥è¾“å…¥åºåˆ—xï¼Œè¾“å‡ºåºåˆ—yï¼Œæ¨¡å‹å‚æ•°wï¼Œç‰¹å¾å‡½æ•°fk

1. æ±‚è§£æ¡ä»¶æ¦‚ç‡$P(Y_i=y_iï½œx)$ å’Œ$P(Y_{i-1}=y_{i-1},Y_i=y_iï½œx)$
2. è”åˆåˆ†å¸ƒå’Œæ¡ä»¶åˆ†å¸ƒçš„æ•°å­¦æœŸæœ›ã€‚

### 2.1.1 å‰å‘åå‘ç®—æ³•

å®šä¹‰

$$
\alpha_0(y|x) =\left\{
\begin{array}{}
1 , y =start\\
0, not
\end{array}
\right.
$$

$$
\alpha_i(y_i|x) = a_{i-1}(y_{i-1}|x)[M_{i}(y_{i-1},y_i,x)]
$$

å…¶ä¸­ï¼Œ$[M_{i}(y_{i-1},y_i,x)]$ä¸ºä» $y_{i-1}$ è½¬ç§»åˆ° $y_i$ çš„éè§„èŒƒåŒ–æ¦‚ç‡ã€‚

å‡è®¾ yi çš„å¯èƒ½å–å€¼æœ‰ m ç§ï¼Œåˆ™ï¼š

$$
a_i^T(x) = a_{i-1}^T(x) M_i{(x)}
$$

åŒç†ï¼Œæœ‰

$$
\beta_i(x) = M_{i+1}(x)\beta_{i+1}(x)
$$

å¯ä»¥å¾—åˆ°

$$
Z(x) = a^T_n(x) \mathbf{1} = \mathbf{1}\beta_n^T(x)
$$

### 2.1.2 æ¡ä»¶æ¦‚ç‡

$$
P(Y_i=y_i|x) = \frac{\alpha_i(y_i|x)\beta_i(y_i|x)}{Z_(x)}
$$

$$
P(Y_{i-1}=y_{i-1},Y_i=y_i|x) = \frac{\alpha_{i-1}(y_{i-1}|x)M_i(y_{i-1},y_i|x)\beta_i(y_i|x)}{Z(x)}
$$

### 2.1.3 æ•°å­¦æœŸæœ›

å¾—åˆ°äº†æ¡ä»¶æ¦‚ç‡ï¼Œå¾ˆå¥½æ±‚è§£è”åˆåˆ†å¸ƒå’Œæ¡ä»¶åˆ†å¸ƒçš„æ•°å­¦æœŸæœ›ã€‚

å·²çŸ¥ç‰¹å¾å‡½æ•°ä¸ºï¼š
$$
f_k(y_,x) = \sum_{i=1}^n(f_k(y_{i-1},y_i,x,i))
$$
å…¶å…³äºP(y|x)çš„æ•°å­¦æœŸæœ›ï¼š
$$
E_{P(y|x)}[f_k] = \sum_{y}P(y|x)f_k(y,x) = \sum\limits_{y}P(y|x) \sum\limits_{i=1}^{n+1}f_k(y_{i-1},y_i,x, i) 
$$
åŒç†ï¼ŒP(y,x)çš„æœŸæœ›ï¼š
$$
\begin{aligned}
E_{P(x,y)}[f_k] &
= \sum\limits_{x,y}P(x,y) \sum\limits_{i=1}^{n+1}f_k(y_{i-1},y_i,x, i)\\
& = \sum\limits_{x}\overline{P}(x) \sum\limits_{y}P(y|x) \sum\limits_{i=1}^{n+1}f_k(y_{i-1},y_i,x, i) 
\end{aligned}
$$

## 2.2 å­¦ä¹ 

æè¿°ï¼šç»™å®šè®­ç»ƒæ•°æ®é›†Xï¼Œå¯¹åº”æ ‡è®°åºåˆ—Yï¼ŒKä¸ªç‰¹å¾å‡½æ•° fk(y,x)ï¼Œå­¦ä¹ å‚æ•°wkï¼Œå¹¶æ±‚æ¡ä»¶æ¦‚ç‡Pw(yï½œx)

è¾“å…¥ï¼šç‰¹å¾å‡½æ•°$f_k(y_{i-1},y_i,x,i)$ï¼Œè§‚æµ‹åºåˆ— $x=(x_1,x_2,...,x_n)$ï¼ŒçŠ¶æ€åºåˆ— $y=(y_1,y_2,...,y_n)$ï¼Œ

è¾“å‡ºï¼šæƒå€¼ $\hat w_k$ï¼Œæ¨¡å‹$P_w(yï½œx)$

æ€è·¯ï¼šä½¿ç”¨éšæœºæ¢¯åº¦ä¸‹é™æ¥å­¦ä¹ ã€‚

1. æ¡ä»¶æ¦‚ç‡æ»¡è¶³æ¡ä»¶ï¼š

$$
P_w(y|x) = \frac{1}{Z_w(x)} \exp (\sum_{k=1}^Kw_kf_k(y,x)) = \frac{ \exp (\sum_{k=1}^Kw_kf_k(y,x))}{\sum_y \exp (\sum_{k=1}^Kw_kf_k(y,x))}
$$

2. æå¤§ä¼¼ç„¶ï¼š

$$
L(w) = \log \prod_{x,y} P_w(y|x)^{\overline P(x,y)} = \sum_{x,y} \overline P(x,y) \log P_w(y|x)
$$

3. è½¬åŒ–ä¸ºæŸå¤±ï¼š

$$
\begin{aligned}
f(w) & = -L(w) \\
 & = \sum_{x,y}\overline P(x,y)\log(Z_w(x)) - \sum_{x,y}\overline P(x,y)\sum _{k=1}^Kw_kf_k(x,y)\\
& =  \sum_{x}\overline P(x)\log(Z_w(x)) - \sum_{x,y}\overline P(x,y)\sum _{k=1}^Kw_kf_k(x,y)\\
& =  \sum_{x}\overline P(x)\log(\sum_y \exp \sum _{k=1}^Kw_kf_k(x,y)) - \sum_{x,y}\overline P(x,y)\sum _{k=1}^Kw_kf_k(x,y)
\end{aligned}
$$

4. æ±‚æ¢¯åº¦ï¼š	

$$
\frac{\partial f(w)}{\partial w} = \sum\limits_{x,y}\overline{P}(x)P_w(y|x)f(x,y) -  \sum\limits_{x,y}\overline{P}(x,y)f(x,y)
$$

## 2.3 è§£ç 

è¾“å…¥ï¼šç‰¹å¾å‡½æ•°$f_k(y_{i-1},y_i,x,i)$ï¼Œæƒå€¼ $w_k$ï¼Œè§‚æµ‹åºåˆ— $x=(x_1,x_2,...,x_n)$

è¾“å‡ºï¼šæœ€ä¼˜è·¯å¾„ y

æ­¥éª¤ï¼š

1. åˆå§‹åŒ–ï¼š

$$
\delta_1(j) = \sum_{k=1}^Kw_kf_k(y_o=start,y_1=j,x,i) , j=1,2,...,m
$$

2. é€’å½’ï¼š

$$
\delta_i(l) = \max\{ \delta_{i-1}(j)+\sum_{k=1}^Kw_kf_k(y_{i-1}=j,y_i=l,x,i))\}
$$

$$
\Psi_i(l) = \arg \max_{j} \{ \delta_{i-1}(j)+\sum_{k=1}^Kw_kf_k(y_{i-1}=j,y_i=l,x,i))\}
$$

2. å›æº¯ï¼š

$$
y_n^* = \arg \max_j \delta_n(j)
$$

$$
y_{i}^* = \Psi_{i+1}(y_{i+1}^*)
$$

# 3. CRFåº”ç”¨

## 3.1 ä¸­æ–‡åˆ†è¯

åˆ†è¯çš„è¾“å…¥ä¸ºä¸€å¥è¯ï¼ˆæ–‡å­—åºåˆ—ï¼‰xï¼Œè¦é¢„æµ‹æ¯ä¸ªè¯çš„æ ‡ç­¾ {B,E,M,S} ï¼Œå¯¹åº”åˆ°CRFã€‚

é€šè¿‡è®­ç»ƒæ•°æ®è¯­æ–™ï¼Œå¯ä»¥å­¦ä¹ å‚æ•°wkï¼›çŠ¶æ€ç‰¹å¾æ ¹æ®è¯­æ–™æ„é€ ï¼Œè½¬ç§»ç‰¹å¾å›ºå®šä¸º4x4=16ä¸ªã€‚

å†é¢„æµ‹æµ‹è¯•æ•°æ®çš„æ–‡å­—åºåˆ—ï¼Œå³CRFçš„ç»´ç‰¹æ¯”ç®—æ³•ã€‚

## 3.2 è¯æ€§æ ‡æ³¨

ä¸ä¸­æ–‡åˆ†è¯ç±»ä¼¼ã€‚